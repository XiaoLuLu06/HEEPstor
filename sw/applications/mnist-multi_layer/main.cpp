#include <stdio.h>
#include "drivers/fpu.hpp"
#include "gen/model.hpp"

void perform_test_inference() {
    auto systolic_array = SystolicArray::get_default();

    ///////////////////////////////////////////
    // 1. Define input and output buffers
    ///////////////////////////////////////////

    const Matrix<float> inputs = {
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.345655978f, -0.175614789f, -0.300019175f, -0.413473487f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, 0.338834345f, 1.61101139f, 1.46574211f, 1.1586616f, 1.11838865f, 1.10907066f, 0.952971697f, -0.0650380403f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.243116483f, 0.0396188013f, 0.301252395f, 0.661711276f, 0.790303826f, 0.953563392f, 2.03453541f, 0.272845566f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212933f, -0.424212962f, -0.424212933f, -0.424212903f, -0.406612217f, 0.825212836f, 1.50123167f, -0.277042568f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212962f, -0.161395073f, 1.74557674f, 0.299607426f, -0.415462345f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.371007085f, 0.851885617f, 1.27234173f, -0.363987297f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424213022f, -0.419954658f, 0.340921998f, 1.90008187f, 0.150757581f, -0.424212933f, -0.424213022f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.206990808f, 1.59564793f, 0.879835367f, -0.372317314f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, 0.702081621f, 2.26326966f, 0.1431766f, -0.424168915f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, 0.579660296f, 0.879693866f, -0.303180754f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.246345356f, 0.870895863f, 1.52213049f, 1.44576132f, 0.0652294755f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.383045137f, 1.05723345f, 2.06013274f, 1.1730814f, 1.97794259f, 1.03293586f, -0.424212664f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.375587165f, 0.524587631f, 0.169709295f, -0.0600166693f, 2.01254725f, 0.822218239f, -0.424212813f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.412982225f, -0.331856221f, 1.16007757f, 2.05110145f, 0.022772653f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212933f, -0.424212962f, 0.427736223f, 2.1800034f, 0.565805674f, -0.400628269f, -0.424212933f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.424212992f, -0.247907236f, 1.76139319f, 1.48268592f, -0.283207804f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, 0.758108497f, 2.18815827f, 0.193434119f, -0.410221308f, -0.420689583f, -0.409753323f, -0.350510925f, -0.318599463f, -0.397419453f, -0.424212962f, -0.424212962f, -0.424212962f, 1.31915665f, 2.32054639f, 1.11187434f, 1.00328672f, 0.66596818f, 1.00875568f, 1.42207539f, 1.43715f, 0.25066787f, -0.424212992f, -0.424212992f, -0.424212992f, 0.353054523f, 1.51263177f, 1.7134347f, 2.11497068f, 1.68067229f, 1.34212887f, 0.928063393f, 0.496572495f, -0.0571959876f, -0.424212962f, -0.424212962f, -0.424212962f, -0.40764758f, -0.338418514f, -0.309892833f, -0.24292928f, -0.293627441f, -0.362817883f, -0.420375824f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.390661001f, 0.100066967f, -0.351493329f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.129027545f, 1.30790317f, -0.302050918f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212962f, 0.523393512f, 0.865831196f, -0.424212694f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.354582042f, 1.34955013f, 0.401536763f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212933f, -0.424212962f, -0.424212933f, -0.0112913679f, 1.57814693f, -0.0503678247f, -0.424212933f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.42084375f, 0.597426295f, 1.30981064f, -0.340683907f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.34634614f, 1.31024265f, 0.656049848f, -0.420645535f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424213022f, -0.146625385f, 1.83360636f, 0.258041054f, -0.424212962f, -0.424212962f, -0.424213022f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, 0.286743075f, 1.70458448f, -0.160052046f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.195369035f, 0.023802219f, -0.409144998f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.420645565f, -0.0841539353f, 0.281268209f, -0.336788952f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.179849714f, 1.49078906f, 2.34666419f, 0.153658092f, -0.405717194f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.342772305f, 1.39877868f, 2.62902164f, 2.64811444f, 1.78479028f, 0.24983725f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.408770651f, 0.563675404f, 2.51195741f, 2.32078075f, 1.16134155f, 1.52016795f, 1.80837643f, -0.0608497486f, -0.421790659f, -0.424212962f, -0.424212933f, -0.424212933f, -0.366836488f, 1.50018597f, 2.00528884f, 0.216574371f, -0.375885397f, 0.0702228174f, 2.26010108f, 1.08935356f, -0.390146196f, -0.424212933f, -0.424212992f, -0.424212992f, -0.250194281f, 1.81237578f, 0.660681963f, -0.415263414f, -0.414816022f, 0.11486502f, 2.30723524f, 1.31950617f, -0.368526936f, -0.424212992f, -0.424212962f, -0.424212962f, -0.0860726312f, 2.21904802f, 0.561278224f, -0.267075419f, 0.247575492f, 1.91963196f, 2.31848812f, 0.323758483f, -0.417386383f, -0.424212962f, -0.424212962f, -0.424212962f, -0.167062879f, 2.00857019f, 1.7969563f, 1.97525668f, 2.44436216f, 2.57857442f, 1.14911866f, -0.370515525f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.386326611f, 0.663454473f, 2.20337224f, 2.62424898f, 2.21719432f, 0.802845538f, -0.220610321f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.386870623f, -0.00757249584f, 0.331806779f, -0.0270171333f, -0.36039561f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.369336218f, -0.392766714f, -0.424212992f, -0.421130002f, -0.397773802f, -0.421498895f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.423019737f, 0.555720508f, 0.0174469128f, -0.424212992f, -0.360946178f, 0.33779031f, -0.276147723f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.21360071f, 1.36293399f, -0.0577290803f, -0.424213022f, -0.328938395f, 1.11580324f, -0.000203305157f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.376950085f, 0.935508192f, 0.831389844f, -0.398662865f, -0.424212992f, -0.0788770467f, 1.73532844f, 3.07159353e-05f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.106753089f, 1.6379596f, -0.00764402421f, -0.424212903f, -0.424212962f, 0.809489727f, 1.438784f, -0.32472378f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.0338143185f, 1.55025434f, 0.0069558043f, -0.208230853f, -0.0489292108f, 1.70205724f, 0.839463711f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.312887758f, 0.908039808f, 1.45141804f, 1.37458599f, 1.41052473f, 2.36661792f, 0.356749862f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.402286261f, -0.255188614f, -0.248801053f, -0.0801026598f, 2.06682467f, 0.258489192f, -0.424213022f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.424212962f, -0.0666791052f, 1.99705315f, 0.107241824f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.0990816578f, 0.616155028f, -0.327627748f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212873f, -0.424212724f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f}
    };

    HEEPSTOR_ASSERT(inputs.num_cols() == Model::NUM_INPUT_FEATURES);

    size_t batch_size = inputs.num_rows();
    Matrix<float> outputs(batch_size, Model::NUM_OUTPUT_FEATURES);

    ///////////////////////////////////////////
    // 2. Perform inference
    ///////////////////////////////////////////

    printf("Performing inference...\n");

    Model::infer(systolic_array, inputs, outputs);

    ///////////////////////////////////////////
    // 3. Check the output
    ///////////////////////////////////////////

    printf("Inference complete!\n");

    printf("Computed result:\n");
    outputs.print();

    const Matrix<float> expected_outputs = {
        {9.96933086e-05f, 6.35636042e-08f, 1.06057059e-05f, 0.000534403895f, 6.21250956e-06f, 8.66147166e-05f, 9.52740464e-08f, 0.997498095f, 7.97485154e-06f, 0.00175622699f},
        {0.0140825855f, 0.00208053878f, 0.832445383f, 0.00625806442f, 2.06606114e-06f, 0.0242420062f, 0.0584213771f, 1.76684097e-07f, 0.0624662973f, 1.46729974e-06f},
        {2.59949356e-05f, 0.964481652f, 0.00888534728f, 0.00550025562f, 0.001382716f, 0.0016151641f, 0.00529246824f, 0.00525902258f, 0.00496438472f, 0.00259307725f},
        {0.998853683f, 9.49281279e-12f, 6.02634282e-05f, 1.35175487e-05f, 7.30796685e-08f, 0.000895542908f, 8.71465672e-05f, 1.85982281e-05f, 3.21690459e-05f, 3.90002715e-05f},
        {0.000629170798f, 6.95760718e-06f, 0.00390358479f, 0.000162088196f, 0.926747322f, 0.00118422275f, 0.00314390915f, 0.0119571416f, 0.00233091228f, 0.049934607f}
    };

    HEEPSTOR_ASSERT(outputs.num_rows() == batch_size);
    HEEPSTOR_ASSERT(outputs.num_cols() == Model::NUM_OUTPUT_FEATURES);

    printf("Expected output: \n");
    expected_outputs.print();

    auto relative_error_percentage = outputs.relative_error(expected_outputs) * 100.0f;
    printf("Relative error: ");
    printFloat(relative_error_percentage);
    printf("%%\n");

    Matrix<int> output_predictions(1, outputs.num_rows());
    Argmax::forward_batch(outputs, output_predictions);

    printf("Computed Predictions: \n");
    output_predictions.print();

    printf("Expected Predictions: \n");
    printf("[7, 2, 1, 0, 4]\n");

    printf("True label values: \n");
    printf("[7, 2, 1, 0, 4]\n");
}

int main(int argc, char* argv[]) {
    // 1. Enable RISC-V CPU Floating Point Unit
    FloatingPointUnit::enable();

    // 2. Print banner with project name  systolic array size used by the system.
    printf("\n");
    printf("====================================\n");
    printf("Hello from HEEPstor! \n");
    printf("PROJECT: mnist-multi_layer\n");
    printf("SYSTOLIC_ARRAY_SIZE=%u\n", SystolicArray::SIZE);
    printf("====================================\n");
    printf("\n");

    // 3. Perform a test inference
    perform_test_inference();

    // 4. Print arena allocator (memory where non-static matrices are stored) usage information
    {
        printf("\nARENA ALLOCATOR: \n");
        printf("Available bytes: %d, Used bytes: %d\n", StaticArenaAllocator::available_bytes(), StaticArenaAllocator::used_bytes());

        // NOTE: You may clear the arena allocator after inference to recover the used memory for other inferences.
        StaticArenaAllocator::reset();
    }

    // 5. Print a reminder to disable Heepstor asserts when functionality has been established to be
    //  correct in order to avoid expensive checks during inference.
    // TODO: Disable heepstor assert for better performance
    printf("NOTE: Disable heepstor assert for better performance\n");
}