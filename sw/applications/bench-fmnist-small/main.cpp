// DO NOT EDIT. File generated automatically, your changes will be lost when regenerated.
#include <stdio.h>
#include "drivers/fpu.hpp"
#include "gen/model.hpp"
#include "profiling/performance_timer.hpp"

void perform_test_inference() {
    auto systolic_array = SystolicArray::get_default();

    ///////////////////////////////////////////
    // 1. Define input and output buffers
    ///////////////////////////////////////////

    const Matrix<float> inputs = {
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.423932195f, -0.421925873f, -0.421925902f, -0.407741159f, -0.411598384f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, -0.424212992f, -0.420782298f, -0.356793195f, 0.0359686576f, -0.359428048f, -0.408650756f, -0.0861193985f, -0.216753989f, -0.424212962f, -0.424212962f, -0.423978984f, -0.423417479f, -0.423067898f, -0.398756504f, 0.174434975f, 1.11348116f, 1.11070931f, 0.999103189f, 1.10167778f, -0.0585696511f, -0.424212933f, -0.42327705f, -0.420185655f, -0.416158378f, -0.404699445f, -0.0201414507f, 0.836180389f, 1.31155324f, 1.53876913f, 1.6394515f, 1.46162462f, 0.198164389f, -0.419610351f, -0.415977091f, -0.408700436f, -0.312492996f, 0.0570263602f, 0.803663611f, 1.06349885f, 1.39438033f, 1.49103844f, 1.5608449f, 1.49826539f, 0.818836212f, -0.153604314f, 0.196916044f, 0.423945993f, 0.750060201f, 1.0059737f, 1.11501431f, 1.27659738f, 1.44987655f, 1.54459226f, 1.54220581f, 1.58847773f, 1.2499249f, 0.673654079f, 1.09905708f, 1.21390045f, 1.19316745f, 1.23597896f, 1.41074061f, 1.54737055f, 1.64552915f, 1.82321513f, 2.16941309f, 2.07384324f, 1.31097603f, -0.270905793f, -0.030479664f, 0.361010104f, 0.567147911f, 0.610986054f, 0.609161079f, 0.305473477f, -0.0382475965f, 0.240340099f, 0.732416332f, 0.612998426f, 0.22680296f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212933f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.220504463f, 0.681097507f, 1.52358115f, 1.63128316f, 1.65719414f, 1.63048756f, 0.946686685f, -0.124190129f, -0.424212962f, -0.424212962f, -0.424212962f, -0.340796828f, 1.28427148f, 2.42798781f, 2.49918532f, 2.56093216f, 2.57426929f, 2.53411055f, 2.46841908f, 1.50664198f, -0.291953832f, -0.424212962f, -0.424212962f, -0.236097187f, 2.08737564f, 2.38778234f, 1.42367411f, 2.32284832f, 1.6583451f, 2.00847101f, 2.06952643f, 2.26089787f, 0.0012936967f, -0.424212962f, -0.424212992f, -0.161973968f, 2.17866087f, 2.55245376f, 1.17013872f, 1.1228646f, 0.678966761f, 0.526988685f, 1.45379686f, 2.53654361f, 0.304946363f, -0.424212992f, -0.424212962f, 0.00172040472f, 2.31778526f, 2.69429803f, 1.16294062f, 1.02713335f, 1.38286877f, 1.32585323f, 1.89878249f, 2.65124679f, 0.482046068f, -0.424212962f, -0.424212933f, 0.163531929f, 2.43874454f, 2.49602175f, 2.44052863f, 2.51158381f, 2.54320574f, 2.47511029f, 2.41826034f, 2.65676546f, 0.616273224f, -0.424212873f, -0.424212992f, 0.286789894f, 2.52525687f, 1.87238836f, 2.47379994f, 2.55051446f, 2.5508132f, 2.56860685f, 2.09697247f, 2.47777462f, 0.802564144f, -0.424212784f, -0.424212962f, 0.355336338f, 2.47567177f, 1.8675245f, 2.50116682f, 2.56177449f, 2.56331897f, 2.58343816f, 1.92246246f, 2.36734104f, 0.996240377f, -0.424212694f, -0.424212962f, 0.342756718f, 2.40105724f, 2.05560493f, 2.55934167f, 2.57010412f, 2.57756209f, 2.57328653f, 1.98167264f, 2.24329662f, 1.15928245f, -0.424212545f, -0.424212992f, 0.316364378f, 2.43789935f, 2.23653507f, 2.57127404f, 2.56428695f, 2.56861258f, 2.57539201f, 2.24598241f, 2.1335156f, 1.26457119f, -0.424212456f, -0.424212962f, 0.25258556f, 2.21347952f, 1.37889135f, 1.66471505f, 1.62554753f, 1.62821496f, 1.63890612f, 1.34753931f, 1.70916975f, 1.33338451f, -0.424212456f, -0.424212962f, -0.01487708f, 1.823457f, 0.0170144755f, -0.415388018f, -0.415120602f, -0.415120661f, -0.414853245f, -0.377504319f, 1.27568793f, 0.980385482f, -0.424212605f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.418417066f, 1.23511016f, 2.22808957f, 2.14541292f, 2.13111377f, 0.390281618f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.401330262f, 1.78213179f, 2.51928473f, 2.47759056f, 2.4485805f, 0.850203097f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.219119519f, 1.99892461f, 2.52495837f, 2.50109339f, 2.45110464f, 0.982059658f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, 0.0202805214f, 2.26242733f, 2.29182339f, 2.04421926f, 2.49616814f, 0.853186309f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, 0.149961084f, 2.39145756f, 1.65053618f, 1.40079069f, 2.50596762f, 0.829847336f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212933f, 0.184355348f, 2.42681789f, 1.23965597f, 0.861387908f, 2.43959284f, 0.727594197f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.424212992f, 0.17182602f, 2.3751564f, 0.889430642f, 0.365732759f, 2.38287759f, 0.674791992f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, 0.036810901f, 2.25466204f, 0.907759607f, 0.193480387f, 2.38005042f, 0.635554433f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.253873318f, 1.92821789f, 1.24761105f, 0.170235038f, 2.38704252f, 0.621691406f, -0.424213022f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.414070189f, 1.60645533f, 1.52087033f, 0.192907304f, 2.29003644f, 0.605134726f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.414386034f, 0.88705945f, 2.03715634f, 0.333584994f, 2.19150567f, 0.553148448f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.418076128f, 0.246158853f, 1.75362277f, 0.258111715f, 1.85735035f, 0.538588583f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.424212962f, -0.424212962f, -0.232948646f, 1.51823306f, 1.80550075f, 1.63622689f, 1.46908522f, 0.1637301f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.113962457f, 1.83282459f, 2.3202188f, 2.28540373f, 2.02749181f, 0.222120449f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.166018918f, 1.23785126f, 1.77026391f, 2.23638582f, 1.58797145f, -0.0711527541f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.234035373f, 0.851932943f, 0.990311444f, 1.75445306f, 1.02909875f, -0.159753516f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.275685817f, 0.811835229f, 0.857314348f, 1.42166138f, 0.964750051f, -0.210125491f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212933f, -0.353660822f, 0.692081332f, 0.799586833f, 1.26973557f, 0.763771176f, -0.297427475f, -0.424212962f, -0.424212933f, -0.424212933f, -0.424212992f, -0.424212992f, -0.424212992f, -0.418097496f, 0.557873309f, 0.847019434f, 1.10595918f, 0.670134366f, -0.325618625f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424072623f, 0.835001409f, 0.940094829f, 0.618332028f, 0.929780543f, -0.254346788f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.423318058f, 1.42835331f, 1.10645688f, 0.36588189f, 1.84281635f, -0.065782994f, -0.424213022f, -0.424212962f, -0.424212962f, -0.424212992f, -0.424212992f, -0.424212992f, -0.424213022f, 1.47411895f, 1.08930373f, 0.338436604f, 1.94052458f, -0.0912890509f, -0.424213022f, -0.424212992f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, 1.37910044f, 1.09166396f, 0.1871631f, 1.81432664f, -0.182609558f, -0.424212992f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212962f, -0.424212992f, 0.798125803f, 0.875601709f, 0.0392877832f, 1.36153746f, -0.338467062f, -0.424212992f, -0.424212962f, -0.424212962f},
        {-0.424212962f, -0.415709645f, -0.38273257f, -0.014523061f, 0.686619639f, 1.22687757f, 1.31961191f, 1.13772321f, 0.454547107f, -0.181637749f, -0.420041531f, -0.424212962f, -0.424212962f, -0.410383672f, 0.124317631f, 0.920440674f, 0.956558228f, 1.28038764f, 1.56185961f, 1.24860311f, 1.26616216f, 1.00616944f, -0.243243024f, -0.423571229f, -0.424212962f, -0.36202246f, 0.640732288f, 0.959336221f, 0.863865554f, 0.929106474f, 1.36122024f, 1.15703607f, 1.30623019f, 1.57844543f, 0.161332548f, -0.423701555f, -0.424212992f, -0.26936844f, 0.9657498f, 1.03645146f, 0.795357764f, 0.91165489f, 0.934327185f, 1.05623984f, 1.55935299f, 1.78458321f, 0.427642733f, -0.424212843f, -0.424212962f, -0.0843383148f, 1.09007239f, 1.24884808f, 0.8703233f, 0.897745073f, 0.970745265f, 1.15695083f, 1.65498137f, 1.7396338f, 0.828659296f, -0.424212545f, -0.424212933f, 0.0411630645f, 1.13797867f, 1.11843932f, 0.83438468f, 0.920306027f, 0.993095696f, 1.15862715f, 1.37787628f, 1.57372212f, 1.08150911f, -0.420121133f, -0.424212992f, 0.164701819f, 1.15557957f, 0.859051883f, 0.821890533f, 0.957297564f, 1.0197953f, 1.11552906f, 1.12773693f, 1.49049139f, 1.23958266f, -0.347501934f, -0.424212962f, 0.297728986f, 1.17762601f, 0.66339618f, 0.858519971f, 0.965270221f, 1.04065704f, 1.13620698f, 1.12133217f, 1.29681277f, 1.32347512f, -0.227031499f, -0.424212962f, 0.451929569f, 1.22121f, 0.714815021f, 0.917165101f, 0.985339522f, 1.04753876f, 1.08043289f, 1.26734996f, 1.20425546f, 1.18492651f, -0.14856641f, -0.424212992f, -0.287899077f, -0.06647975f, 0.567296326f, 0.955209434f, 1.03858924f, 1.12674236f, 1.04351151f, 1.4106915f, 0.364938021f, -0.17582497f, -0.386369079f, -0.424212962f, -0.422363222f, -0.260430634f, 0.850575686f, 1.03054941f, 1.04608524f, 1.16106057f, 1.1141417f, 1.41450202f, 0.433352351f, -0.41765067f, -0.424212962f, -0.424212962f, -0.423089892f, -0.362503707f, 0.36675629f, 1.0185169f, 1.20005751f, 1.29534888f, 1.24618077f, 0.932197452f, 0.00638842629f, -0.42084372f, -0.424212962f}
    };

    HEEPSTOR_ASSERT(inputs.num_cols() == Model::NUM_INPUT_FEATURES);

    size_t batch_size = inputs.num_rows();
    Matrix<float> outputs(batch_size, Model::NUM_OUTPUT_FEATURES);

    ///////////////////////////////////////////
    // 2. Perform inference
    ///////////////////////////////////////////

    printf("Performing inference...\n");

    Model::infer(systolic_array, inputs, outputs, CheckpointPerformanceTimerDisplayConfig::Seconds);

    ///////////////////////////////////////////
    // 3. Check the output
    ///////////////////////////////////////////

    printf("Inference complete!\n");

    printf("Computed result:\n");
    outputs.print();

    const Matrix<float> expected_outputs = {
        {3.38387617e-05f, 1.88906165e-06f, 1.16045403e-05f, 7.04228933e-06f, 4.91414903e-06f, 0.149081647f, 4.20421493e-05f, 0.388899416f, 0.00825000182f, 0.453667641f},
        {0.000181799813f, 6.08619814e-07f, 0.88566941f, 3.69834452e-05f, 0.00455184095f, 5.08856113e-09f, 0.109465793f, 1.943809e-10f, 9.35600401e-05f, 3.05877018e-10f},
        {0.000104258819f, 0.999533176f, 1.37098377e-05f, 0.000167415827f, 0.000177821406f, 5.54085222e-09f, 3.34083188e-06f, 6.62476829e-09f, 1.86505517e-07f, 1.12195309e-07f},
        {0.000129305961f, 0.994685769f, 9.15498385e-05f, 0.00478610722f, 0.000287875679f, 8.63735522e-07f, 1.61847056e-05f, 2.1790369e-07f, 6.47913851e-07f, 1.59742194e-06f},
        {0.17050454f, 0.00172943424f, 0.102942631f, 0.0179527719f, 0.012550612f, 0.000134849819f, 0.688358843f, 3.3418728e-05f, 0.00573280966f, 6.01055435e-05f}
    };

    printf("Expected output: \n");
    expected_outputs.print();

    auto relative_error_percentage = outputs.relative_error(expected_outputs) * 100.0f;
    printf("Relative error: ");
    printFloat(relative_error_percentage);
    printf("%%\n");

    Matrix<int> output_predictions(1, batch_size);
    Argmax::forward_batch(outputs, output_predictions);

    printf("Computed Predictions: \n");
    output_predictions.print();

    printf("Expected Predictions: \n");
    printf("[9, 2, 1, 1, 6]\n");

    printf("True label values: \n");
    printf("[9, 2, 1, 1, 6]\n");
}

int main(int argc, char* argv[]) {
    // 1. Enable RISC-V CPU Floating Point Unit
    FloatingPointUnit::enable();

    // 2. Print banner with project name  systolic array size used by the system.
    printf("\n");
    printf("====================================\n");
    printf("Hello from HEEPstor! \n");
    printf("PROJECT: bench-fmnist-small\n");
#if USE_SOFTWARE_DNN_LAYER_OPERATORS
    printf("USING SOFTWARE DNN OPERATORS\n");
#else
    printf("SYSTOLIC_ARRAY_SIZE=%u\n", SystolicArray::SIZE);
#endif
    printf("====================================\n");
    printf("\n");

    // 3. Perform a test inference
    perform_test_inference();

    // 4. Print arena allocator (memory where non-static matrices are stored) usage information
    {
        printf("\nARENA ALLOCATOR: \n");
        printf("Available bytes: %d, Used bytes: %d\n", StaticArenaAllocator::available_bytes(), StaticArenaAllocator::used_bytes());

        // NOTE: You may clear the arena allocator after inference to recover the used memory for other inferences.
        StaticArenaAllocator::reset();
    }

    // 5. Print a reminder to disable Heepstor asserts when functionality has been established to be
    //  correct in order to avoid expensive checks during inference.
#if ENABLE_DEBUG_HEEPSTOR_ASSERTIONS
    printf("NOTE: Disable heepstor assert for better performance\n");
#endif
}